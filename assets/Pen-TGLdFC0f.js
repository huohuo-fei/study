var k=Object.defineProperty;var L=(a,t,e)=>t in a?k(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var r=(a,t,e)=>L(a,typeof t!="symbol"?t+"":t,e);import{d as D,r as _,e as b,c as E,a as x,u as A,b as N,F as B,o as I,_ as X}from"./index-Ck6tq5XS.js";class P{}r(P,"START_POINT_SIZE",6),r(P,"START_POINT_COLOR","#558ef0"),r(P,"START_POINT_UNLINK_COLOR","red"),r(P,"HELPER_COLOR","#1c7aef"),r(P,"HELPER_RADIUS",4);class Y{constructor(){r(this,"link");r(this,"centerPoint",{x:0,y:0});r(this,"perPoint",{x:0,y:0});r(this,"nextPoint",{x:0,y:0});r(this,"originPoint",null);r(this,"selectControlType","center");this.link=!0}updateHelper(t){this.originPoint=t,this.centerPoint.x=t.x,this.centerPoint.y=t.y,this.perPoint.x=t.perControlPoint.x,this.perPoint.y=t.perControlPoint.y,this.nextPoint.x=t.nextControlPoint.x,this.nextPoint.y=t.nextControlPoint.y,this.link=t.link}render(t){t.save(),t.strokeStyle=P.HELPER_COLOR,t.fillStyle=P.HELPER_COLOR,t.setLineDash([5]),t.beginPath(),this.link?(t.moveTo(this.perPoint.x,this.perPoint.y),t.lineTo(this.nextPoint.x,this.nextPoint.y),t.stroke()):(t.moveTo(this.perPoint.x,this.perPoint.y),t.lineTo(this.centerPoint.x,this.centerPoint.y),t.moveTo(this.centerPoint.x,this.centerPoint.y),t.lineTo(this.nextPoint.x,this.nextPoint.y),t.stroke()),t.moveTo(this.perPoint.x,this.perPoint.y),t.arc(this.perPoint.x,this.perPoint.y,P.HELPER_RADIUS,0,Math.PI*2),t.moveTo(this.nextPoint.x,this.nextPoint.y),t.arc(this.nextPoint.x,this.nextPoint.y,P.HELPER_RADIUS,0,Math.PI*2),t.fill(),t.restore()}searchPoint(t,e,n){return n.save(),n.beginPath(),n.arc(this.perPoint.x,this.perPoint.y,P.HELPER_RADIUS,0,Math.PI*2),n.isPointInPath(t,e)?(this.selectControlType="next","next"):(n.beginPath(),n.arc(this.nextPoint.x,this.nextPoint.y,P.HELPER_RADIUS,0,Math.PI*2),n.isPointInPath(t,e)?(this.selectControlType="per","per"):(this.selectControlType="center","center"))}onPointermove(t){var e;(this.selectControlType==="per"||this.selectControlType==="next")&&((e=this.originPoint)==null||e.updateControlPointByDir(t,this.selectControlType),this.updateHelper(this.originPoint))}onPointerup(t){this.selectControlType="center"}}class H{constructor(t){r(this,"activePoint",null);r(this,"penHelper",new Y);r(this,"points",[]);r(this,"isDrawHeple",!1);r(this,"ctx");this.ctx=t}exportPoints(){return JSON.parse(JSON.stringify(this.points))}onPointerdown(t){}onPointermove(t){}onPointerup(t){}render(t){this.drawPoint(t),this.drawHelp(t),this.drawActivePath(t),this.drawPath(t)}dispose(){for(let t in this)this.hasOwnProperty(t)&&delete this[t]}drawPoint(t){t.save();for(let e of this.points)e.link?t.fillStyle=P.START_POINT_COLOR:t.fillStyle=P.START_POINT_UNLINK_COLOR,t.fillRect(e.x-P.START_POINT_SIZE/2,e.y-P.START_POINT_SIZE/2,P.START_POINT_SIZE,P.START_POINT_SIZE);t.restore()}drawHelp(t){this.isDrawHeple&&this.penHelper.render(t)}drawActivePath(t){if(this.points.length&&this.activePoint){const e=this.points[this.points.length-1];t.save(),t.beginPath(),t.moveTo(e.x,e.y),t.bezierCurveTo(e.nextControlPoint.x,e.nextControlPoint.y,this.activePoint.perControlPoint.x,this.activePoint.perControlPoint.y,this.activePoint.x,this.activePoint.y),t.stroke(),t.restore()}}drawPath(t){if(this.points.length>1){t.save(),t.beginPath(),t.strokeStyle=P.START_POINT_COLOR;const e=this.points[0];t.moveTo(e.x,e.y);for(let n=1,h=this.points.length;n<h;n++){const i=this.points[n-1],l=this.points[n];t.bezierCurveTo(i.nextControlPoint.x,i.nextControlPoint.y,l.perControlPoint.x,l.perControlPoint.y,l.x,l.y)}t.stroke(),t.restore()}}}class O{constructor(t,e){r(this,"x");r(this,"y");this.x=t,this.y=e}updatePoint(t,e){this.x=t,this.y=e}}class T{constructor(t){r(this,"x");r(this,"y");r(this,"link");r(this,"perControlPoint");r(this,"nextControlPoint");this.x=t.x,this.y=t.y,this.link=!0,this.perControlPoint=new O(this.x,this.y),this.nextControlPoint=new O(this.x,this.y)}restorePoint(t){this.x=t.x,this.y=t.y,this.perControlPoint.updatePoint(t.perControlPoint.x,t.perControlPoint.y),this.nextControlPoint.updatePoint(t.nextControlPoint.x,t.nextControlPoint.y),this.link=t.link}updateControlPoint(t){const{x:e,y:n}=t;this.link&&this.symmetric(e,n)}updateControlPointByDir(t,e){const{x:n,y:h}=t;this.link?this.symmetric(n,h,e):this.unSymmetric(n,h,e)}updatePointPos(t){const{x:e,y:n}=t,h=e-this.x,i=n-this.y;this.x+=h,this.y+=i,this.perControlPoint.updatePoint(this.perControlPoint.x+h,this.perControlPoint.y+i),this.nextControlPoint.updatePoint(this.nextControlPoint.x+h,this.nextControlPoint.y+i)}symmetric(t,e,n="per"){if(n==="next"){this.perControlPoint.updatePoint(t,e);const h=t-this.x,i=e-this.y;this.nextControlPoint.updatePoint(this.x-h,this.y-i)}else{this.nextControlPoint.updatePoint(t,e);const h=t-this.x,i=e-this.y;this.perControlPoint.updatePoint(this.x-h,this.y-i)}}unSymmetric(t,e,n="per"){n==="next"?this.perControlPoint.updatePoint(t,e):this.nextControlPoint.updatePoint(t,e)}render(){}}class U extends H{onPointerdown(t){const e=new T(t);this.points.push(e),this.isDrawHeple=!0,this.penHelper.updateHelper(e),this.activePoint=null}onPointermove(t){if(this.isDrawHeple){const e=this.points[this.points.length-1];e.updateControlPoint(t),this.penHelper.updateHelper(e)}else{const e=new T(t);this.activePoint=e}}onPointerup(t){this.isDrawHeple=!1}render(t){super.render(t)}}class $ extends H{constructor(e,n){super(e);r(this,"editPoint",null);r(this,"isOperate",!1);this.points=n,this.restore(n)}restore(e){this.points=e.map(n=>{const h={x:n.x,y:n.y},i=new T(h);return i.restorePoint(n),i})}onPointerdown(e){this.isOperate=!0,this.searchEditPoint(e)}onPointermove(e){this.isOperate&&(this.editPoint&&!this.isDrawHeple?this.editPoint.updatePointPos(e):this.penHelper.onPointermove(e))}onPointerup(e){this.editPoint&&(this.isDrawHeple=!0,this.penHelper.updateHelper(this.editPoint)),this.isOperate=!1}render(e){super.render(e)}searchEditPoint(e){const n=this.searchPointByXY(e.x,e.y);if(n){e.ctrlKey&&(n.link=!1),this.editPoint=n,this.isDrawHeple=!1;return}if(this.editPoint&&this.penHelper.searchPoint(e.x,e.y,this.ctx)!=="center"){this.isDrawHeple=!0;return}this.isDrawHeple=!1,this.editPoint=null}searchPointByXY(e,n){for(let h of this.points){const i={x:h.x,y:h.y},l=P.START_POINT_SIZE,w=i.x-l,y=i.x+l,m=i.y-l,g=i.y+l;if(e>=w&&e<=y&&n>=m&&n<=g)return h}}}class j{constructor(t){r(this,"ctx");r(this,"toolParser");this.ctx=t,this.toolParser=new U(this.ctx)}render(){this.toolParser.render(this.ctx)}onDrawOver(){const t=this.toolParser.exportPoints();this.toolParser.dispose(),this.toolParser=new $(this.ctx,t)}onPointerdown(t){const e=this.createEvent(t);t.ctrlKey&&(e.ctrlKey=!0),this.toolParser.onPointerdown(e)}onPointermove(t){const e=this.createEvent(t);this.toolParser.onPointermove(e)}onPointerup(t){const e=this.createEvent(t);this.toolParser.onPointerup(e)}createEvent(t){return{x:t.clientX,y:t.clientY,rawEvent:t}}clipCanvas(t,e){return new Promise((n,h)=>{var w;if(this.ctx.save(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.toolParser.drawPath(this.ctx),this.ctx.clip(),e.bitmap){const{bitmap:y,offsetX:m,offsetY:g,scale:v}=e;(w=this.ctx)==null||w.drawImage(y,0,0,y.width,y.height,m,g,y.width*v,y.height*v)}const i=document.createElement("canvas");i.width=t.width,i.height=t.height;const l=i.getContext("2d");l==null||l.drawImage(this.ctx.canvas,t.x,t.y,t.width,t.height,0,0,t.width,t.height),i.toBlob(y=>{n(y)}),this.ctx.restore()})}exportPenPoints(){return this.toolParser.exportPoints()}dispose(){this.toolParser.dispose();for(const t in this)this.hasOwnProperty(t)&&delete this[t]}}const M=["width","height"],Z={class:"operate"},F={class:"svg-box"},K=["width","height"],z=D({__name:"Pen",props:{size:{type:Object,default:{width:0,height:0}}},setup(a){const t=a,e=N(),n=_(),h=_();let i;const l={bitmap:null,offsetX:0,offsetY:0,scale:0};b(async()=>{const o=await w();R(o),y(),m()});const w=async()=>{const s=await(await fetch("https://huohuo-fei.github.io/study/resource/test-bg.jpeg")).blob();return createImageBitmap(s)},y=()=>{const o=n.value;o==null||o.addEventListener("pointerdown",s=>{s.button===0?i==null||i.onPointerdown(s):s.button===2&&(i==null||i.onDrawOver())}),o==null||o.addEventListener("pointermove",s=>{i==null||i.onPointermove(s)}),o==null||o.addEventListener("pointerup",s=>{i==null||i.onPointerup(s)}),o==null||o.addEventListener("contextmenu",s=>(s.preventDefault(),!1))},m=()=>{const o=n.value,s=o==null?void 0:o.getContext("2d");if(s==null||s.clearRect(0,0,o==null?void 0:o.width,o==null?void 0:o.height),l.bitmap){const{bitmap:p,offsetX:c,offsetY:d,scale:f}=l;s==null||s.drawImage(p,0,0,p.width,p.height,c,d,p.width*f,p.height*f)}i==null||i.render(),requestAnimationFrame(m)},g=()=>{i&&i.dispose();const o=n.value,s=o==null?void 0:o.getContext("2d");i=new j(s)},v=()=>{if(!i)return;const o=i.exportPenPoints();if(!o.length)return;let s="";const p=o[0];s+=`M ${p.x} ${p.y} `;for(let c=1,d=o.length;c<d;c++){const f=o[c-1],u=o[c];s+=`C ${f.nextControlPoint.x} ${f.nextControlPoint.y} ${u.perControlPoint.x} ${u.perControlPoint.y} ${u.x} ${u.y} `}if(h.value){const c=h.value.querySelector("path");c.setAttribute("d",s);const d=c.getBBox();i.clipCanvas(d,l).then(f=>{const u=URL.createObjectURL(f),C=document.createElement("a");C.href=u,C.download="image.png",C.click(),URL.revokeObjectURL(u)})}},R=o=>{const{width:s,height:p}=o,c=s/p;let d=1;c<=1?d=t.size.height/p:d=t.size.width/s;const f=(t.size.width-s*d)/2,u=(t.size.height-p*d)/2;l.bitmap=o,l.offsetX=f,l.offsetY=u,l.scale=d},S=o=>{var s;if(i&&(i.dispose(),i=null),o.target){const p=(s=o.target.files)==null?void 0:s[0];if(p){const c=new FileReader;c.onload=function(d){var f;if((f=d.target)!=null&&f.result){const u=new Image;u.src=d.target.result,u.onload=function(){createImageBitmap(u).then(C=>{R(C)})}}},c.readAsDataURL(p)}}};return(o,s)=>(I(),E(B,null,[x("canvas",{ref_key:"canvasRef",ref:n,width:a.size.width,height:a.size.height},null,8,M),x("div",Z,[x("button",{onClick:g},"start"),x("button",{onClick:v},"download"),x("button",{onClick:s[0]||(s[0]=p=>A(e).replace("/"))},"Home"),x("input",{type:"file",accept:"image/png, image/jpeg",onInput:S},null,32)]),x("div",F,[(I(),E("svg",{ref_key:"svgRef",ref:h,width:a.size.width,height:a.size.height,xmlns:"http://www.w3.org/2000/svg"},s[1]||(s[1]=[x("path",{stroke:"transparent",fill:"transparent"},null,-1)]),8,K))])],64))}}),G=X(z,[["__scopeId","data-v-f11fc304"]]);export{G as default};
