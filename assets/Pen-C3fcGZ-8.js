var S=Object.defineProperty;var k=(l,t,e)=>t in l?S(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e;var h=(l,t,e)=>k(l,typeof t!="symbol"?t+"":t,e);import{d as L,r as R,e as D,c as _,a as x,F as A,o as E,_ as b}from"./index-B5-EKOCl.js";class a{}h(a,"START_POINT_SIZE",6),h(a,"START_POINT_COLOR","#558ef0"),h(a,"START_POINT_UNLINK_COLOR","red"),h(a,"HELPER_COLOR","#1c7aef"),h(a,"HELPER_RADIUS",4);class N{constructor(){h(this,"link");h(this,"centerPoint",{x:0,y:0});h(this,"perPoint",{x:0,y:0});h(this,"nextPoint",{x:0,y:0});h(this,"originPoint",null);h(this,"selectControlType","center");this.link=!0}updateHelper(t){this.originPoint=t,this.centerPoint.x=t.x,this.centerPoint.y=t.y,this.perPoint.x=t.perControlPoint.x,this.perPoint.y=t.perControlPoint.y,this.nextPoint.x=t.nextControlPoint.x,this.nextPoint.y=t.nextControlPoint.y,this.link=t.link}render(t){t.save(),t.strokeStyle=a.HELPER_COLOR,t.fillStyle=a.HELPER_COLOR,t.setLineDash([5]),t.beginPath(),this.link?(t.moveTo(this.perPoint.x,this.perPoint.y),t.lineTo(this.nextPoint.x,this.nextPoint.y),t.stroke()):(t.moveTo(this.perPoint.x,this.perPoint.y),t.lineTo(this.centerPoint.x,this.centerPoint.y),t.moveTo(this.centerPoint.x,this.centerPoint.y),t.lineTo(this.nextPoint.x,this.nextPoint.y),t.stroke()),t.moveTo(this.perPoint.x,this.perPoint.y),t.arc(this.perPoint.x,this.perPoint.y,a.HELPER_RADIUS,0,Math.PI*2),t.moveTo(this.nextPoint.x,this.nextPoint.y),t.arc(this.nextPoint.x,this.nextPoint.y,a.HELPER_RADIUS,0,Math.PI*2),t.fill(),t.restore()}searchPoint(t,e,n){return n.save(),n.beginPath(),n.arc(this.perPoint.x,this.perPoint.y,a.HELPER_RADIUS,0,Math.PI*2),n.isPointInPath(t,e)?(this.selectControlType="next","next"):(n.beginPath(),n.arc(this.nextPoint.x,this.nextPoint.y,a.HELPER_RADIUS,0,Math.PI*2),n.isPointInPath(t,e)?(this.selectControlType="per","per"):(this.selectControlType="center","center"))}onPointermove(t){var e;(this.selectControlType==="per"||this.selectControlType==="next")&&((e=this.originPoint)==null||e.updateControlPointByDir(t,this.selectControlType),this.updateHelper(this.originPoint))}onPointerup(t){this.selectControlType="center"}}class O{constructor(t){h(this,"activePoint",null);h(this,"penHelper",new N);h(this,"points",[]);h(this,"isDrawHeple",!1);h(this,"ctx");this.ctx=t}exportPoints(){return JSON.parse(JSON.stringify(this.points))}onPointerdown(t){}onPointermove(t){}onPointerup(t){}render(t){this.drawPoint(t),this.drawHelp(t),this.drawActivePath(t),this.drawPath(t)}dispose(){for(let t in this)this.hasOwnProperty(t)&&delete this[t]}drawPoint(t){t.save();for(let e of this.points)e.link?t.fillStyle=a.START_POINT_COLOR:t.fillStyle=a.START_POINT_UNLINK_COLOR,t.fillRect(e.x-a.START_POINT_SIZE/2,e.y-a.START_POINT_SIZE/2,a.START_POINT_SIZE,a.START_POINT_SIZE);t.restore()}drawHelp(t){this.isDrawHeple&&this.penHelper.render(t)}drawActivePath(t){if(this.points.length&&this.activePoint){const e=this.points[this.points.length-1];t.save(),t.beginPath(),t.moveTo(e.x,e.y),t.bezierCurveTo(e.nextControlPoint.x,e.nextControlPoint.y,this.activePoint.perControlPoint.x,this.activePoint.perControlPoint.y,this.activePoint.x,this.activePoint.y),t.stroke(),t.restore()}}drawPath(t){if(this.points.length>1){t.save(),t.beginPath(),t.strokeStyle=a.START_POINT_COLOR;const e=this.points[0];t.moveTo(e.x,e.y);for(let n=1,i=this.points.length;n<i;n++){const r=this.points[n-1],P=this.points[n];t.bezierCurveTo(r.nextControlPoint.x,r.nextControlPoint.y,P.perControlPoint.x,P.perControlPoint.y,P.x,P.y)}t.stroke(),t.restore()}}}class I{constructor(t,e){h(this,"x");h(this,"y");this.x=t,this.y=e}updatePoint(t,e){this.x=t,this.y=e}}class T{constructor(t){h(this,"x");h(this,"y");h(this,"link");h(this,"perControlPoint");h(this,"nextControlPoint");this.x=t.x,this.y=t.y,this.link=!0,this.perControlPoint=new I(this.x,this.y),this.nextControlPoint=new I(this.x,this.y)}restorePoint(t){this.x=t.x,this.y=t.y,this.perControlPoint.updatePoint(t.perControlPoint.x,t.perControlPoint.y),this.nextControlPoint.updatePoint(t.nextControlPoint.x,t.nextControlPoint.y),this.link=t.link}updateControlPoint(t){const{x:e,y:n}=t;this.link&&this.symmetric(e,n)}updateControlPointByDir(t,e){const{x:n,y:i}=t;this.link?this.symmetric(n,i,e):this.unSymmetric(n,i,e)}updatePointPos(t){const{x:e,y:n}=t,i=e-this.x,r=n-this.y;this.x+=i,this.y+=r,this.perControlPoint.updatePoint(this.perControlPoint.x+i,this.perControlPoint.y+r),this.nextControlPoint.updatePoint(this.nextControlPoint.x+i,this.nextControlPoint.y+r)}symmetric(t,e,n="per"){if(n==="next"){this.perControlPoint.updatePoint(t,e);const i=t-this.x,r=e-this.y;this.nextControlPoint.updatePoint(this.x-i,this.y-r)}else{this.nextControlPoint.updatePoint(t,e);const i=t-this.x,r=e-this.y;this.perControlPoint.updatePoint(this.x-i,this.y-r)}}unSymmetric(t,e,n="per"){n==="next"?this.perControlPoint.updatePoint(t,e):this.nextControlPoint.updatePoint(t,e)}render(){}}class B extends O{onPointerdown(t){const e=new T(t);this.points.push(e),this.isDrawHeple=!0,this.penHelper.updateHelper(e),this.activePoint=null}onPointermove(t){if(this.isDrawHeple){const e=this.points[this.points.length-1];e.updateControlPoint(t),this.penHelper.updateHelper(e)}else{const e=new T(t);this.activePoint=e}}onPointerup(t){this.isDrawHeple=!1}render(t){super.render(t)}}class X extends O{constructor(e,n){super(e);h(this,"editPoint",null);h(this,"isOperate",!1);this.points=n,this.restore(n)}restore(e){this.points=e.map(n=>{const i={x:n.x,y:n.y},r=new T(i);return r.restorePoint(n),r})}onPointerdown(e){this.isOperate=!0,this.searchEditPoint(e)}onPointermove(e){this.isOperate&&(this.editPoint&&!this.isDrawHeple?this.editPoint.updatePointPos(e):this.penHelper.onPointermove(e))}onPointerup(e){this.editPoint&&(this.isDrawHeple=!0,this.penHelper.updateHelper(this.editPoint)),this.isOperate=!1}render(e){super.render(e)}searchEditPoint(e){const n=this.searchPointByXY(e.x,e.y);if(n){e.ctrlKey&&(n.link=!1),this.editPoint=n,this.isDrawHeple=!1;return}if(this.editPoint&&this.penHelper.searchPoint(e.x,e.y,this.ctx)!=="center"){this.isDrawHeple=!0;return}this.isDrawHeple=!1,this.editPoint=null}searchPointByXY(e,n){for(let i of this.points){const r={x:i.x,y:i.y},P=a.START_POINT_SIZE,w=r.x-P,f=r.x+P,m=r.y-P,g=r.y+P;if(e>=w&&e<=f&&n>=m&&n<=g)return i}}}class Y{constructor(t){h(this,"ctx");h(this,"toolParser");this.ctx=t,this.toolParser=new B(this.ctx)}render(){this.toolParser.render(this.ctx)}onDrawOver(){const t=this.toolParser.exportPoints();this.toolParser.dispose(),this.toolParser=new X(this.ctx,t)}onPointerdown(t){const e=this.createEvent(t);t.ctrlKey&&(e.ctrlKey=!0),this.toolParser.onPointerdown(e)}onPointermove(t){const e=this.createEvent(t);this.toolParser.onPointermove(e)}onPointerup(t){const e=this.createEvent(t);this.toolParser.onPointerup(e)}createEvent(t){return{x:t.clientX,y:t.clientY,rawEvent:t}}clipCanvas(t,e){return new Promise((n,i)=>{var w;if(this.ctx.save(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.toolParser.drawPath(this.ctx),this.ctx.clip(),e.bitmap){const{bitmap:f,offsetX:m,offsetY:g,scale:C}=e;(w=this.ctx)==null||w.drawImage(f,0,0,f.width,f.height,m,g,f.width*C,f.height*C)}const r=document.createElement("canvas");r.width=t.width,r.height=t.height;const P=r.getContext("2d");P==null||P.drawImage(this.ctx.canvas,t.x,t.y,t.width,t.height,0,0,t.width,t.height),r.toBlob(f=>{n(f)}),this.ctx.restore()})}exportPenPoints(){return this.toolParser.exportPoints()}dispose(){this.toolParser.dispose();for(const t in this)this.hasOwnProperty(t)&&delete this[t]}}const U=["width","height"],$={class:"operate"},j={class:"svg-box"},M=["width","height"],Z=L({__name:"Pen",props:{size:{type:Object,default:{width:0,height:0}}},setup(l){const t=l,e=R(),n=R();let i;const r={bitmap:null,offsetX:0,offsetY:0,scale:0};D(async()=>{const o=await P();C(o),w(),f()});const P=async()=>{const s=await(await fetch("/resource/test-bg.jpeg")).blob();return createImageBitmap(s)},w=()=>{const o=e.value;o==null||o.addEventListener("pointerdown",s=>{s.button===0?i==null||i.onPointerdown(s):s.button===2&&(i==null||i.onDrawOver())}),o==null||o.addEventListener("pointermove",s=>{i==null||i.onPointermove(s)}),o==null||o.addEventListener("pointerup",s=>{i==null||i.onPointerup(s)}),o==null||o.addEventListener("contextmenu",s=>(s.preventDefault(),!1))},f=()=>{const o=e.value,s=o==null?void 0:o.getContext("2d");if(s==null||s.clearRect(0,0,o==null?void 0:o.width,o==null?void 0:o.height),r.bitmap){const{bitmap:p,offsetX:c,offsetY:d,scale:y}=r;s==null||s.drawImage(p,0,0,p.width,p.height,c,d,p.width*y,p.height*y)}i==null||i.render(),requestAnimationFrame(f)},m=()=>{i&&i.dispose();const o=e.value,s=o==null?void 0:o.getContext("2d");i=new Y(s)},g=()=>{if(!i)return;const o=i.exportPenPoints();if(!o.length)return;let s="";const p=o[0];s+=`M ${p.x} ${p.y} `;for(let c=1,d=o.length;c<d;c++){const y=o[c-1],u=o[c];s+=`C ${y.nextControlPoint.x} ${y.nextControlPoint.y} ${u.perControlPoint.x} ${u.perControlPoint.y} ${u.x} ${u.y} `}if(n.value){const c=n.value.querySelector("path");c.setAttribute("d",s);const d=c.getBBox();i.clipCanvas(d,r).then(y=>{const u=URL.createObjectURL(y),v=document.createElement("a");v.href=u,v.download="image.png",v.click(),URL.revokeObjectURL(u)})}},C=o=>{const{width:s,height:p}=o,c=s/p;let d=1;c<=1?d=t.size.height/p:d=t.size.width/s;const y=(t.size.width-s*d)/2,u=(t.size.height-p*d)/2;r.bitmap=o,r.offsetX=y,r.offsetY=u,r.scale=d},H=o=>{var s;if(i&&(i.dispose(),i=null),o.target){const p=(s=o.target.files)==null?void 0:s[0];if(p){const c=new FileReader;c.onload=function(d){var y;if((y=d.target)!=null&&y.result){const u=new Image;u.src=d.target.result,u.onload=function(){createImageBitmap(u).then(v=>{C(v)})}}},c.readAsDataURL(p)}}};return(o,s)=>(E(),_(A,null,[x("canvas",{ref_key:"canvasRef",ref:e,width:l.size.width,height:l.size.height},null,8,U),x("div",$,[x("button",{onClick:m},"start"),x("button",{onClick:g},"download"),x("input",{type:"file",accept:"image/png, image/jpeg",onInput:H},null,32)]),x("div",j,[(E(),_("svg",{ref_key:"svgRef",ref:n,width:l.size.width,height:l.size.height,xmlns:"http://www.w3.org/2000/svg"},s[0]||(s[0]=[x("path",{stroke:"transparent",fill:"transparent"},null,-1)]),8,M))])],64))}}),z=b(Z,[["__scopeId","data-v-154b0d49"]]);export{z as default};
